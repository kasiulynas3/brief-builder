<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BEST HOOK GENERATOR IN THE WORLD</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Mono', monospace;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1a3e 50%, #0f0a1f 100%);
      min-height: 100vh;
      padding: 0;
      margin: 0;
      color: #e0f0ff;
      position: relative;
      overflow: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(0, 255, 200, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 0, 200, 0.08) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SIDEBAR NAVIGATION
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .sidebar {
      width: 80px;
      background: rgba(10, 14, 39, 0.98);
      border-right: 2px solid rgba(0, 255, 100, 0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px 0;
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      z-index: 100;
      flex-shrink: 0;
    }

    .sidebar-logo {
      font-size: 2.2rem;
      margin-bottom: 40px;
      animation: glow 3s ease-in-out infinite;
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 25px;
      flex: 1;
    }

    .nav-item {
      font-size: 1.5rem;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.3s;
      padding: 12px;
      border-radius: 0;
      border: 2px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
    }

    .nav-item:hover, .nav-item.active {
      opacity: 1;
      border: 2px solid #00ff64;
      box-shadow: 0 0 20px rgba(0, 255, 100, 0.5);
      background: rgba(0, 255, 100, 0.1);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MAIN CONTENT AREA
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .main-content {
      margin-left: 80px;
      width: calc(100% - 80px);
      padding: 40px;
      overflow-y: auto;
      max-height: 100vh;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1a3e 50%, #0f0a1f 100%);
    }

    .top-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 50px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .main-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.8rem;
      font-weight: 900;
      background: linear-gradient(90deg, #00ff64, #00ffff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0 0 10px 0;
      letter-spacing: 3px;
    }

    .main-subtitle {
      font-size: 1rem;
      color: #00ff64;
      opacity: 0.8;
      margin: 0;
    }

    .header-btn {
      background: linear-gradient(135deg, #00ff64 0%, #00dd40 100%);
      color: #0a0e27;
      border: 2px solid #00ff64;
      padding: 14px 32px;
      border-radius: 0;
      font-weight: 700;
      cursor: pointer;
      font-size: 1rem;
      font-family: 'Orbitron', sans-serif;
      letter-spacing: 2px;
      box-shadow: 0 0 30px rgba(0, 255, 100, 0.6);
      transition: all 0.3s;
      text-transform: uppercase;
      position: relative;
      overflow: hidden;
    }

    .header-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 50px rgba(0, 255, 100, 0.9);
      background: linear-gradient(135deg, #00ff64, #ff00ff);
    }

    .card {
      background: linear-gradient(135deg, rgba(20, 20, 50, 0.85) 0%, rgba(40, 30, 60, 0.85) 100%);
      border: 2px solid #00ff64;
      border-radius: 0;
      padding: 40px;
      margin-bottom: 50px;
      box-shadow: 
        0 0 30px rgba(0, 255, 100, 0.3),
        inset 0 0 30px rgba(0, 255, 100, 0.08),
        0 0 60px rgba(0, 255, 100, 0.15);
      position: relative;
      backdrop-filter: blur(10px);
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, #00ff64, #00ffff, transparent);
      box-shadow: 0 0 15px #00ff64, 0 0 30px #00ffff;
    }

    .card h2 {
      font-family: 'Orbitron', sans-serif;
      font-size: 2rem;
      color: #00ff64;
      margin-bottom: 30px;
      text-shadow: 0 0 15px rgba(0, 255, 100, 0.6);
      letter-spacing: 3px;
      font-weight: 900;
    }

    .form-group {
      margin-bottom: 30px;
    }

    label {
      display: block;
      font-weight: 700;
      margin-bottom: 12px;
      color: #00ff64;
      text-shadow: 0 0 8px rgba(0, 255, 100, 0.4);
      font-size: 1.05rem;
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    input, textarea {
      width: 100%;
      padding: 16px;
      border: 2px solid #00ff64;
      border-radius: 0;
      font-family: 'Space Mono', monospace;
      font-size: 1rem;
      background: rgba(0, 255, 100, 0.08);
      color: #e0f0ff;
      transition: all 0.3s;
      box-shadow: 0 0 15px rgba(0, 255, 100, 0.2);
      line-height: 1.6;
    }

    input::placeholder, textarea::placeholder {
      color: rgba(0, 255, 100, 0.5);
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #00ffff;
      background: rgba(0, 255, 100, 0.1);
      box-shadow: 
        0 0 30px rgba(0, 255, 100, 0.5),
        inset 0 0 15px rgba(0, 255, 100, 0.15);
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    .btn-submit {
      background: linear-gradient(135deg, #00ff64 0%, #00dd40 100%);
      color: #0a0e27;
      border: 2px solid #00ff64;
      padding: 16px 40px;
      border-radius: 0;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-block;
      font-family: 'Orbitron', sans-serif;
      letter-spacing: 2px;
      box-shadow: 0 0 25px rgba(0, 255, 100, 0.6);
      text-transform: uppercase;
      position: relative;
      overflow: hidden;
    }

    .btn-submit::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }

    .btn-submit:hover:not(:disabled)::before {
      left: 100%;
    }

    .btn-submit:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 
        0 0 40px rgba(0, 255, 100, 0.9),
        0 0 80px rgba(0, 255, 100, 0.5);
      background: linear-gradient(135deg, #00ff64 0%, #00ffff 100%);
    }

    .btn-submit:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .model-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 35px;
      padding: 25px;
      background: rgba(0, 255, 100, 0.08);
      border: 1px solid rgba(0, 255, 100, 0.4);
      border-radius: 0;
    }

    .model-option {
      flex: 1;
    }

    .model-radio {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }

    .model-radio input{
      cursor: pointer;
      width: 20px;
      height: 20px;
      accent-color: #00ff64;
    }

    .model-radio label {
      margin: 0;
      cursor: pointer;
      color: #00ff64;
      font-weight: 600;
      font-size: 1rem;
    }

    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(0, 255, 100, 0.3);
      border-top-color: #00ff64;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Angles Section */
    .angles-section {
      display: none;
    }

    .angles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .angle-btn {
      background: rgba(0, 255, 100, 0.08);
      border: 2px solid #00ff64;
      padding: 28px;
      border-radius: 0;
      font-size: 1.05rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      color: #00ff64;
      font-family: 'Space Mono', monospace;
      box-shadow: 0 0 20px rgba(0, 255, 100, 0.25);
      position: relative;
      overflow: hidden;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1.5;
    }

    .angle-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0, 255, 100, 0.3), transparent);
      transition: left 0.5s;
    }

    .angle-btn:hover {
      border-color: #00ffff;
      transform: translateY(-4px);
      box-shadow: 
        0 0 35px rgba(0, 255, 255, 0.7),
        inset 0 0 15px rgba(0, 255, 100, 0.15);
      background: rgba(0, 255, 100, 0.12);
    }

    .angle-btn:hover::before {
      left: 100%;
    }

    .angle-btn.active {
      background: linear-gradient(135deg, rgba(0, 255, 100, 0.25) 0%, rgba(0, 255, 100, 0.25) 100%);
      border: 2px solid;
      border-image: linear-gradient(135deg, #00ff64, #00ffff) 1;
      box-shadow: 
        0 0 40px rgba(0, 255, 100, 0.6),
        0 0 30px rgba(255, 0, 255, 0.4);
      color: #00ff64;
    }

    /* Hooks Section */
    .hooks-section {
      display: none;
    }

    .hooks-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 22px;
    }

    .hook-card {
      background: linear-gradient(135deg, rgba(0, 255, 100, 0.08) 0%, rgba(0, 255, 100, 0.05) 100%);
      border-left: 4px solid #ff00ff;
      border: 2px solid #00ff64;
      border-left: 4px solid #ff00ff;
      padding: 24px;
      border-radius: 0;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      box-shadow: 0 0 20px rgba(0, 255, 100, 0.25);
    }

    .hook-card:hover {
      border-color: #00ffff;
      border-left: 4px solid #00ff64;
      transform: translateX(6px);
      box-shadow: 
        0 0 30px rgba(0, 255, 100, 0.5),
        inset 0 0 20px rgba(0, 255, 100, 0.12);
      background: linear-gradient(135deg, rgba(0, 255, 100, 0.12) 0%, rgba(0, 255, 100, 0.08) 100%);
    }

    .hook-text {
      font-size: 1.05rem;
      line-height: 1.7;
      color: #e0f0ff;
      margin-bottom: 15px;
      font-weight: 500;
    }

    .hook-label {
      font-size: 0.9rem;
      color: #00ff64;
      font-weight: 700;
      margin-bottom: 12px;
      text-shadow: 0 0 8px rgba(0, 255, 100, 0.4);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .hook-actions {
      display: flex;
      gap: 12px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .hook-btn {
      background: linear-gradient(135deg, #00ffff 0%, #00ccff 100%);
      color: #0a0e27;
      border: 1px solid #00ffff;
      padding: 8px 16px;
      border-radius: 0;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Orbitron', sans-serif;
      box-shadow: 0 0 15px rgba(0, 255, 100, 0.4);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .hook-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 25px rgba(0, 255, 255, 0.7);
      background: linear-gradient(135deg, #00ffff 0%, #ff00ff 100%);
    }

    /* Whisk Prompts */
    .whisk-section {
      display: none;
    }

    .prompt-card {
      background: linear-gradient(135deg, rgba(20, 20, 50, 0.95) 0%, rgba(40, 30, 60, 0.95) 100%);
      border: 2px solid #00ffff;
      border-radius: 0;
      padding: 28px;
      transition: all 0.3s;
      position: relative;
      box-shadow: 0 0 25px rgba(0, 255, 100, 0.3);
    }

    .prompt-card:hover {
      border: 2px solid;
      border-image: linear-gradient(135deg, #00ffff, #ff00ff) 1;
      box-shadow: 
        0 0 40px rgba(0, 255, 100, 0.6),
        0 0 30px rgba(255, 0, 255, 0.4);
      transform: translateY(-4px);
    }

    .prompt-style {
      font-weight: 900;
      font-size: 0.95rem;
      color: #00ff64;
      margin-bottom: 18px;
      text-transform: uppercase;
      letter-spacing: 2.5px;
      font-family: 'Orbitron', sans-serif;
      text-shadow: 0 0 12px rgba(0, 255, 100, 0.5);
    }

    .prompt-text {
      color: #e0f0ff;
      font-size: 1rem;
      line-height: 1.7;
      margin-bottom: 20px;
      background: rgba(0, 255, 100, 0.08);
      padding: 18px;
      border-left: 3px solid #ff00ff;
      border-radius: 0;
      min-height: 120px;
      max-height: 250px;
      overflow-y: auto;
      box-shadow: inset 0 0 15px rgba(0, 255, 100, 0.1);
    }

    .prompt-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* Modal */
    #modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: linear-gradient(135deg, rgba(20, 20, 50, 0.98) 0%, rgba(40, 30, 60, 0.98) 100%);
      border: 2px solid;
      border-image: linear-gradient(135deg, #00ffff, #ff00ff) 1;
      border-radius: 0;
      max-width: 700px;
      max-height: 85vh;
      overflow-y: auto;
      padding: 40px;
      box-shadow: 
        0 0 50px rgba(0, 255, 100, 0.5),
        inset 0 0 30px rgba(0, 255, 100, 0.12);
      position: relative;
    }

    .modal-content h2 {
      color: #00ff64;
      font-family: 'Orbitron', sans-serif;
      margin-bottom: 25px;
      font-size: 1.8rem;
    }

    /* Status Messages */
    #statusMessage {
      position: fixed;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
      max-width: 600px;
      padding: 18px 30px;
      border-radius: 0;
      display: none;
      align-items: center;
      font-weight: 700;
      font-family: 'Orbitron', sans-serif;
      animation: slideIn 0.4s ease;
      border: 2px solid;
      font-size: 1.05rem;
      letter-spacing: 1.5px;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    #statusMessage.success {
      background: rgba(0, 255, 100, 0.15);
      border-color: #00ff64;
      color: #00ff64;
      box-shadow: 0 0 30px rgba(0, 255, 100, 0.5);
    }

    #statusMessage.error {
      background: rgba(255, 0, 100, 0.15);
      border-color: #ff0064;
      color: #ff0064;
      box-shadow: 0 0 30px rgba(255, 0, 100, 0.5);
    }

    #statusMessage.loading {
      background: rgba(0, 200, 255, 0.15);
      border-color: #00c8ff;
      color: #00c8ff;
      box-shadow: 0 0 30px rgba(0, 200, 255, 0.5);
    }

    .news-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 30px;
      margin-top: 30px;
    }

    .news-card {
      background: rgba(0, 255, 100, 0.08);
      border: 2px solid #00ffff;
      border-radius: 0;
      padding: 25px;
      box-shadow: 0 0 20px rgba(0, 255, 100, 0.25);
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      min-height: 200px;
    }

    .news-card:hover {
      border: 2px solid;
      border-image: linear-gradient(135deg, #00ffff, #ff00ff) 1;
      box-shadow: 
        0 0 35px rgba(0, 255, 100, 0.5),
        0 0 20px rgba(255, 0, 255, 0.3);
      transform: translateY(-3px);
    }

    .news-card h4 {
      color: #00ff64;
      font-family: 'Orbitron', sans-serif;
      margin-bottom: 15px;
      font-size: 1.2rem;
      text-shadow: 0 0 10px rgba(0, 255, 100, 0.4);
    }

    .news-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 300px;
      overflow-y: auto;
    }

    .news-list li {
      padding: 12px;
      border-bottom: 1px solid rgba(0, 255, 100, 0.2);
      color: #e0e0ff;
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .news-list li:last-child {
      border-bottom: none;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 30px;
    }

    header button {
      background: linear-gradient(135deg, #00ffff 0%, #00ccff 100%);
      color: #0a0e27;
      border: 2px solid #00ffff;
      padding: 14px 28px;
      border-radius: 0;
      font-weight: 700;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s;
      font-family: 'Orbitron', sans-serif;
      letter-spacing: 2px;
      box-shadow: 0 0 20px rgba(0, 255, 100, 0.4);
      text-transform: uppercase;
    }

    header button:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 0 35px rgba(0, 255, 255, 0.7),
        0 0 20px rgba(255, 0, 255, 0.3);
      background: linear-gradient(135deg, #00ffff 0%, #ff00ff 100%);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 255, 100, 0.05);
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #00ffff, #ff00ff);
      border-radius: 0;
      box-shadow: 0 0 10px rgba(0, 255, 100, 0.5);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #ff00ff, #00ffff);
      box-shadow: 0 0 15px rgba(255, 0, 255, 0.7);
    }
  </style>
</head>
<body>
  <!-- Left Sidebar Navigation -->
  <div class="sidebar">
    <div class="sidebar-logo">âœ¨</div>
    <nav class="sidebar-nav">
      <a href="#" class="nav-item active" title="Generator">âš¡</a>
      <a href="#" class="nav-item" title="History">ğŸ“œ</a>
      <a href="#" class="nav-item" title="Settings">âš™ï¸</a>
      <a href="#" class="nav-item" title="Community">ğŸ‘¥</a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Top Header -->
    <div class="top-header">
      <div>
        <h1 class="main-title">ğŸš€ HOOK GENERATOR</h1>
        <p class="main-subtitle">Create Viral Ad Angles & Hooks Powered by AI</p>
      </div>
      <button class="header-btn" onclick="startNew()">Start New â†’</button>
    </div>

    <div class="card">
      <h2>Your Product</h2>
      
      <div class="form-group">
        <label>Product Name</label>
        <input type="text" id="productName" placeholder="e.g., Energy Boost, Vitamin D Pro, etc.">
      </div>

      <div class="form-group">
        <label>Product Context & Positioning</label>
        <textarea id="productContext" placeholder="Describe your product, key benefits, target audience, unique selling points..."></textarea>
      </div>

      <div class="model-selector">
        <div class="model-option">
          <div class="model-radio">
            <input type="radio" id="modelOllama" name="model" value="ollama" checked>
            <label for="modelOllama">ğŸ¤– Ollama (Local, Free)</label>
          </div>
        </div>
        <div class="model-option">
          <div class="model-radio">
            <input type="radio" id="modelGemini" name="model" value="gemini">
            <label for="modelGemini">âœ¨ Gemini (Fast)</label>
          </div>
        </div>
        <div class="model-option">
          <div class="model-radio">
            <input type="radio" id="modelOpenRouter" name="model" value="openrouter">
            <label for="modelOpenRouter">ğŸš€ OpenRouter (Powerful)</label>
          </div>
        </div>
        <div class="model-option">
          <div class="model-radio">
            <input type="radio" id="modelGroq" name="model" value="groq">
            <label for="modelGroq">âš¡ Groq (Ultra-Fast)</label>
          </div>
        </div>
      </div>

      <button class="btn-submit" onclick="generateAngles()">
        âœ¨ Generate 3 Angles
      </button>
    </div>

    <!-- Ad Analysis Section -->
    <div class="card">
      <h2>ğŸ” Analyze Competitor Ads & Generate Hooks</h2>
      <p style="color: #00ff64; margin-bottom: 15px; font-size: 0.95rem;">Upload a competitor ad to analyze their strategy and automatically generate 5 Meta-compliant hooks with matching visual style.</p>
      
      <div class="form-group">
        <label>Your Product Name</label>
        <input type="text" id="adProductName" placeholder="e.g., GutHealth Pro">
      </div>
      
      <div class="form-group">
        <label>Your Product Context</label>
        <textarea id="adProductContext" placeholder="e.g., Probiotic supplement for digestive health..."></textarea>
      </div>
      
      <div class="form-group">
        <label>Upload Competitor Ad Image</label>
        <input type="file" id="adImageUpload" accept="image/*" style="padding: 10px; border: 2px dashed #00ff64; border-radius: 0; background: rgba(0, 255, 100, 0.08);">
      </div>
      
      <button class="btn-submit" onclick="analyzeAd()" style="background: linear-gradient(135deg, #00ff64 0%, #00dd40 100%);">
        ğŸ¤– Analyze & Generate Hooks
      </button>
      
      <div id="adAnalysisResult" style="display: none; margin-top: 20px; padding: 20px; background: rgba(0, 255, 100, 0.08); border-radius: 0; border-left: 4px solid #00ff64;">
        <h3 style="margin-bottom: 10px; color: #00ff64;">ğŸ“Š Analysis Results:</h3>
        <div id="adAnalysisText" style="white-space: pre-wrap; line-height: 1.6; color: #e0f0ff; margin-bottom: 20px; padding: 15px; background: rgba(0, 255, 100, 0.05); border-radius: 0;"></div>
      </div>
    </div>

    <!-- Ad-Inspired Hooks Section -->
    <div class="card" id="adInspiredHooksSection" style="display: none;">
      <h2>ğŸ¯ Hooks Inspired by Competitor Ad</h2>
      <p style="color: #00ff64; margin-bottom: 20px; font-size: 0.95rem;">These hooks are inspired by the competitor's strategy, adapted for your product, and fully Meta-compliant.</p>
      <div id="adInspiredHooksGrid" class="hooks-grid"></div>
    </div>

    <!-- Competitor Intelligence News -->
    <div class="card" id="competitorNewsSection">
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
        <h2>ğŸ§  Competitor Intelligence</h2>
        <div style="display: flex; gap: 8px; align-items: center;">
          <select id="periodSelector" onchange="changePeriod()" style="padding: 8px 12px; border-radius: 0; border: 2px solid #00ff64; background: rgba(0, 255, 100, 0.08); color: #00ff64; font-size: 0.9rem; cursor: pointer;">
            <option value="current">Current (Live)</option>
            <option value="day">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="year">This Year</option>
          </select>
          <button class="btn-submit" onclick="loadCompetitorNews()" style="margin: 0; padding: 8px 16px;">ğŸ”„ Refresh</button>
        </div>
      </div>
      <p style="color: #00ff64; margin-bottom: 10px; font-size: 0.95rem;">Hourly scraper highlights: popular hooks, themes, and compliance patterns. Click cards to expand/collapse.</p>
      <div id="competitorNewsStatus" style="color: #00ff64; font-weight: 600; margin-bottom: 8px;">Loading insights...</div>
      <div id="competitorNewsMeta" class="news-meta" style="margin-bottom: 10px;"></div>
      <div id="trendIndicators" style="margin-bottom: 10px; padding: 10px; background: #fff; border-radius: 6px; display: none; font-size: 0.9rem;"></div>

      <div class="news-grid">
        <div class="news-card collapsed" id="popularHooksCard">
          <h4 style="margin-bottom: 8px; color: #00ff64;">
            <span class="news-card-title">Popular Hooks</span>
            <span class="news-card-actions">
              <button class="copy-card-btn" onclick="copyCardContent(event, 'popularHooksList', 'Popular Hooks')">ğŸ“‹ All</button>
              <span class="expand-icon">â–¼</span>
            </span>
          </h4>
          <ul id="popularHooksList" class="news-list"></ul>
        </div>
        <div class="news-card collapsed" id="popularAnglesCard">
          <h4 style="margin-bottom: 8px; color: #00ff64;">
            <span class="news-card-title">Popular Angles</span>
            <span class="news-card-actions">
              <button class="copy-card-btn" onclick="copyCardContent(event, 'popularAnglesList', 'Popular Angles')">ğŸ“‹ All</button>
              <span class="expand-icon">â–¼</span>
            </span>
          </h4>
          <ul id="popularAnglesList" class="news-list"></ul>
        </div>
        <div class="news-card collapsed" id="popularThemesCard">
          <h4 style="margin-bottom: 8px; color: #00ff64;">
            <span class="news-card-title">Popular Themes</span>
            <span class="news-card-actions">
              <button class="copy-card-btn" onclick="copyCardContent(event, 'popularThemesList', 'Popular Themes')">ğŸ“‹ All</button>
              <span class="expand-icon">â–¼</span>
            </span>
          </h4>
          <ul id="popularThemesList" class="news-list"></ul>
        </div>
        <div class="news-card collapsed" id="compliancePatternsCard">
          <h4 style="margin-bottom: 8px; color: #00ff64;">
            <span class="news-card-title">Compliance Patterns</span>
            <span class="news-card-actions">
              <button class="copy-card-btn" onclick="copyCardContent(event, 'compliancePatternsList', 'Compliance Patterns')">ğŸ“‹ All</button>
              <span class="expand-icon">â–¼</span>
            </span>
          </h4>
          <ul id="compliancePatternsList" class="news-list"></ul>
        </div>
        <div class="news-card collapsed" id="trendingAdsCard">
          <h4 style="margin-bottom: 8px; color: #00ff64;">
            <span class="news-card-title">Trending Ad Phrases</span>
            <span class="news-card-actions">
              <button class="copy-card-btn" onclick="copyCardContent(event, 'trendingAdsList', 'Trending Phrases')">ğŸ“‹ All</button>
              <span class="expand-icon">â–¼</span>
            </span>
          </h4>
          <ul id="trendingAdsList" class="news-list"></ul>
        </div>
        <div class="news-card collapsed" id="adLinksCard">
          <h4 style="margin-bottom: 8px; color: #00ff64;">
            <span class="news-card-title">Direct Ad Links</span>
            <span class="news-card-actions">
              <button class="copy-card-btn" onclick="copyCardContent(event, 'adLinksList', 'Ad Links')">ğŸ“‹ All</button>
              <span class="expand-icon">â–¼</span>
            </span>
          </h4>
          <ul id="adLinksList" class="news-list"></ul>
        </div>
        <div class="news-card collapsed" id="scraperRunsCard">
          <h4 style="margin-bottom: 8px; color: #00ff64;">
            <span class="news-card-title">Recent Scraper Runs</span>
            <span class="news-card-actions">
              <button class="copy-card-btn" onclick="copyCardContent(event, 'scraperRunsCard', 'Scraper Runs')">ğŸ“‹ All</button>
              <span class="expand-icon">â–¼</span>
            </span>
          </h4>
          <ul id="scraperRunsList" class="news-list"></ul>
        </div>
      </div>
    </div>

    <!-- Angles Selection -->
    <div class="card angles-section" id="anglesSection">
      <h2>Choose Your Angle</h2>
      <div class="angles-grid" id="anglesGrid"></div>
    </div>

    <!-- Hooks Display -->
    <div class="card hooks-section" id="hooksSection">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>Creative Hooks for "<span id="selectedAngleDisplay"></span>"</h2>
        <button class="btn-submit" style="margin: 0;" onclick="copyAllHooks()">ğŸ“‹ Copy All</button>
      </div>
      <div class="hooks-grid" id="hooksGrid"></div>
    </div>

    <!-- Whisk Prompts Section -->
    <div class="card whisk-section" id="whiskSection" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
          <h2>ğŸ¨ Whisk Prompts</h2>
          <p style="color: #00ff64; font-size: 0.95rem; margin-top: 4px;">
            Angle: <strong id="whiskAngleDisplay"></strong> | 
            Hook: <strong id="whiskHookDisplay"></strong>
          </p>
        </div>
        <button class="btn-submit" style="margin: 0;" onclick="copyAllWhiskPrompts()">ğŸ“‹ Copy All</button>
      </div>
      <div id="whiskPromptsContainer">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 20px;">
          <div id="surreal-prompt" class="prompt-card">
            <div class="prompt-style">ğŸŒ€ SURREAL</div>
            <div id="surreal-text" class="prompt-text"></div>
            <div class="prompt-actions">
              <button class="hook-btn" onclick="editPrompt('surreal')">âœï¸ Edit</button>
              <button class="hook-btn" onclick="regeneratePrompt('surreal')">ğŸ”„ Regen</button>
              <button class="hook-btn" onclick="copyPrompt('surreal')">ğŸ“‹ Copy</button>
            </div>
          </div>
          
          <div id="out-of-box-prompt" class="prompt-card">
            <div class="prompt-style">ğŸ’¡ OUT-OF-BOX</div>
            <div id="out-of-box-text" class="prompt-text"></div>
            <div class="prompt-actions">
              <button class="hook-btn" onclick="editPrompt('out-of-box')">âœï¸ Edit</button>
              <button class="hook-btn" onclick="regeneratePrompt('out-of-box')">ğŸ”„ Regen</button>
              <button class="hook-btn" onclick="copyPrompt('out-of-box')">ğŸ“‹ Copy</button>
            </div>
          </div>
          
          <div id="basic-prompt" class="prompt-card">
            <div class="prompt-style">ğŸ“ BASIC</div>
            <div id="basic-text" class="prompt-text"></div>
            <div class="prompt-actions">
              <button class="hook-btn" onclick="editPrompt('basic')">âœï¸ Edit</button>
              <button class="hook-btn" onclick="regeneratePrompt('basic')">ğŸ”„ Regen</button>
              <button class="hook-btn" onclick="copyPrompt('basic')">ğŸ“‹ Copy</button>
            </div>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
          <button class="btn-submit" onclick="saveWhiskPromptToHistory()" style="flex: 1;">ğŸ’¾ Save to History</button>
          <button class="btn-submit" style="background: linear-gradient(135deg, #00ffff 0%, #00ff64 100%);" onclick="openWhiskWindow()">ğŸ¨ Open Whisk</button>
        </div>
      </div>
    </div>

    <!-- Whisk History Section -->
    <div class="card whisk-history-section" id="whiskHistorySection" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>ğŸ“‹ Funnel Workflow History</h2>
        <button class="btn-submit" style="margin: 0; background: #ff4d4f;" onclick="clearWhiskHistory()">ğŸ—‘ï¸ Clear All</button>
      </div>
      <div id="whiskHistoryContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;"></div>
    </div>
  </div>

  <!-- Modal for image prompts -->
  <div id="modal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Brand reveal modal -->
  <div id="brandModal" class="brand-modal" onclick="closeBrandModal(event)">
    <div class="brand-modal-content" onclick="event.stopPropagation()">
      <div class="brand-modal-header">
        <div style="flex: 1;">
          <h3 class="brand-modal-title" id="brandModalTitle"></h3>
          <div class="brand-modal-subtitle" id="brandModalSubtitle"></div>
        </div>
        <button class="brand-modal-close" onclick="closeBrandModal()">&times;</button>
      </div>
      <ul class="brand-list" id="brandModalList"></ul>
    </div>
  </div>

  <script>
    // Global state
    const S = {
      productName: '',
      productContext: '',
      angles: [],
      selectedAngle: '',
      hooks: [],
      currentImagePrompt: '',
      currentHook: '',
      // Ad analysis state
      adAnalysis: '',
      adVisualTheme: '',
      adInspiredHooks: []
    };

    // Store brand mappings globally
    let BRAND_MAPPINGS = {
      hooks: {},
      angles: {},
      compliance: {},
      trending: {}
    };

    // â”€â”€â”€ HISTORY MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function saveToHistory() {
      if (!S.productName || S.angles.length === 0) return;
      
      const history = JSON.parse(localStorage.getItem('hookGeneratorHistory') || '[]');
      
      const session = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        productName: S.productName,
        productContext: S.productContext,
        angles: S.angles,
        selectedAngle: S.selectedAngle,
        hooks: S.hooks
      };
      
      history.unshift(session);
      
      // Keep last 20 sessions
      if (history.length > 20) history.pop();
      
      localStorage.setItem('hookGeneratorHistory', JSON.stringify(history));
    }

    function showHistory() {
      const history = JSON.parse(localStorage.getItem('hookGeneratorHistory') || '[]');
      const modalBody = document.getElementById('modalBody');
      
      if (history.length === 0) {
        modalBody.innerHTML = `
          <h2>ğŸ“œ Session History</h2>
          <p style="color: #666; text-align: center; padding: 40px 20px;">No previous sessions yet. Generate some angles to build your history!</p>
        `;
      } else {
        let historyHtml = `
          <h2>ğŸ“œ Session History</h2>
          <p style="color: #666; margin-bottom: 20px;">Click to restore a previous session. Last 20 sessions saved.</p>
          <div style="max-height: 500px; overflow-y: auto;">
        `;
        
        history.forEach(session => {
          const date = new Date(session.timestamp);
          const timeAgo = getTimeAgo(date);
          
          historyHtml += `
            <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; cursor: pointer; transition: all 0.3s;" 
                 onmouseover="this.style.borderColor='#667eea'" 
                 onmouseout="this.style.borderColor='#e0e0e0'">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                <div onclick="loadSession(${session.id})" style="flex: 1;">
                  <strong style="font-size: 1.1rem; color: #333;">${escapeHtml(session.productName)}</strong>
                  <div style="color: #999; font-size: 0.85rem; margin-top: 4px;">${timeAgo}</div>
                </div>
                <button onclick="event.stopPropagation(); deleteSession(${session.id})" 
                        style="background: #ff4d4f; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;"
                        onmouseover="this.style.background='#ff7875'"
                        onmouseout="this.style.background='#ff4d4f'">
                  ğŸ—‘ï¸ Delete
                </button>
              </div>
              <div onclick="loadSession(${session.id})" style="flex: 1;">
                <div style="color: #666; font-size: 0.9rem; margin-bottom: 8px;">${escapeHtml(session.productContext.substring(0, 100))}${session.productContext.length > 100 ? '...' : ''}</div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                  ${session.angles.map(angle => `<span style="background: #f0f0f0; padding: 4px 10px; border-radius: 4px; font-size: 0.85rem;">${escapeHtml(angle)}</span>`).join('')}
                </div>
                ${session.hooks.length > 0 ? `<div style="margin-top: 8px; color: #52c41a; font-size: 0.85rem;">âœ… ${session.hooks.length} hooks generated</div>` : ''}
              </div>
            </div>
          `;
        });
        
        historyHtml += `</div>`;
        modalBody.innerHTML = historyHtml;
      }
      
      document.getElementById('modal').style.display = 'flex';
    }

    function loadSession(sessionId) {
      const history = JSON.parse(localStorage.getItem('hookGeneratorHistory') || '[]');
      const session = history.find(s => s.id === sessionId);
      
      if (!session) {
        showStatus('âŒ Session not found', 'error');
        return;
      }
      
      // Restore state
      S.productName = session.productName;
      S.productContext = session.productContext;
      S.angles = session.angles;
      S.selectedAngle = session.selectedAngle;
      S.hooks = session.hooks;
      
      // Update UI
      document.getElementById('productName').value = session.productName;
      document.getElementById('productContext').value = session.productContext;
      
      renderAngles();
      document.getElementById('anglesSection').style.display = 'block';
      
      if (session.hooks.length > 0) {
        renderHooks();
        document.getElementById('hooksSection').style.display = 'block';
        document.getElementById('selectedAngleDisplay').textContent = session.selectedAngle;
      }
      
      document.getElementById('modal').style.display = 'none';
      showStatus('âœ… Session restored!', 'success');
      
      // Scroll to generated content
      setTimeout(() => {
        document.getElementById('anglesSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 300);
    }

    function deleteSession(sessionId) {
      if (!confirm('Delete this session from history?')) return;
      
      let history = JSON.parse(localStorage.getItem('hookGeneratorHistory') || '[]');
      history = history.filter(s => s.id !== sessionId);
      localStorage.setItem('hookGeneratorHistory', JSON.stringify(history));
      
      showStatus('âœ… Session deleted', 'success');
      showHistory(); // Refresh the history view
    }

    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
      if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
      return date.toLocaleDateString();
    }

    function toggleScraperRunDetails(event, runId) {
      event.stopPropagation();
      const detailsEl = document.getElementById(`details-${runId}`);
      const iconEl = document.getElementById(`icon-${runId}`);
      
      if (detailsEl) {
        const isOpen = detailsEl.style.display !== 'none';
        detailsEl.style.display = isOpen ? 'none' : 'block';
        if (iconEl) {
          iconEl.textContent = isOpen ? 'â–¶' : 'â–¼';
        }
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showStatus('âœ… Copied!', 'success');
      }).catch(() => {
        showStatus('âŒ Copy failed', 'error');
      });
    }

    function formatDateTime(value) {
      if (!value) return 'Unknown';
      const date = new Date(value);
      return Number.isNaN(date.getTime()) ? 'Unknown' : date.toLocaleString();
    }

    function renderList(targetId, items, emptyText) {
      const target = document.getElementById(targetId);
      if (!target) return;
      if (!items || items.length === 0) {
        target.innerHTML = `<li><span class="news-list-item-content">${emptyText}</span></li>`;
        return;
      }
      
      // Check if this is a mappable list (hooks, angles, compliance)
      const isMappable = ['popularHooksList', 'popularAnglesList', 'compliancePatternsList', 'trendingAdsList'].includes(targetId);
      
      target.innerHTML = items.map(item => {
        const label = typeof item === 'string' ? item : item.text;
        const count = typeof item === 'object' && item.count ? item.count : null;
        const adUrl = typeof item === 'object' ? item.ad_url : null;
        const safeLabel = label.replace(/`/g, '\\`').replace(/"/g, '&quot;');
        const onClick = isMappable ? `showBrands(event, '${targetId}', \`${safeLabel}\`)` : '';
        const countBadge = count ? `<span class="news-count-badge">${count}x</span>` : '';
        const adLink = adUrl ? `<a class="news-item-link" href="${escapeHtml(adUrl)}" target="_blank" rel="noopener">Ad</a>` : '';

        return `
          <li>
            <span class="news-list-item-content ${isMappable ? 'clickable' : ''}" data-value="${escapeHtml(label)}" onclick="${onClick}">${escapeHtml(label)}${countBadge}${adLink}</span>
            <button class="copy-item-btn" onclick="copyListItem(event, this)">ğŸ“‹</button>
          </li>
        `;
      }).join('');
    }

    function copyListItem(event, button) {
      event.stopPropagation();
      
      const listItem = button.closest('li');
      if (!listItem) return;
      
      const content = listItem.querySelector('.news-list-item-content');
      if (!content) return;
      
      // Check if it's a link
      const dataValue = content.getAttribute('data-value');
      if (dataValue) {
        navigator.clipboard.writeText(dataValue).then(() => {
          const originalText = button.textContent;
          button.textContent = 'âœ“';
          button.style.background = '#10b981';
          setTimeout(() => {
            button.textContent = originalText;
            button.style.background = '';
          }, 1000);
        }).catch(err => {
          showStatus('âŒ Failed to copy', 'error');
        });
        return;
      }

      const link = content.querySelector('a');
      const text = link ? link.href : content.textContent.trim().replace(' ğŸ‘ï¸', '');
      
      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.textContent;
        button.textContent = 'âœ“';
        button.style.background = '#10b981';
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = '';
        }, 1000);
      }).catch(err => {
        showStatus('âŒ Failed to copy', 'error');
      });
    }

    function showBrands(event, listType, itemText) {
      event.stopPropagation();
      
      let brands = [];
      let title = '';
      let subtitle = '';
      
      // Determine which mapping to use
      if (listType === 'popularHooksList') {
        brands = BRAND_MAPPINGS.hooks[itemText] || BRAND_MAPPINGS.trending[itemText] || [];
        title = itemText;
        subtitle = `${brands.length} brand${brands.length !== 1 ? 's' : ''} using this hook`;
      } else if (listType === 'popularAnglesList') {
        brands = BRAND_MAPPINGS.angles[itemText] || [];
        title = itemText;
        subtitle = `${brands.length} brand${brands.length !== 1 ? 's' : ''} with this positioning`;
      } else if (listType === 'compliancePatternsList') {
        brands = BRAND_MAPPINGS.compliance[itemText] || [];
        title = itemText;
        subtitle = `${brands.length} brand${brands.length !== 1 ? 's' : ''} using this compliance approach`;
      } else if (listType === 'trendingAdsList') {
        // Extract just the phrase (remove count)
        const phrase = itemText.replace(/ \(\d+x\)$/, '');
        brands = BRAND_MAPPINGS.trending[phrase] || [];
        title = phrase;
        subtitle = `${brands.length} brand${brands.length !== 1 ? 's' : ''} using this phrase`;
      }
      
      if (brands.length === 0) {
        showStatus('No brand data available for this item', 'error');
        return;
      }
      
      // Show modal
      const modal = document.getElementById('brandModal');
      const titleEl = document.getElementById('brandModalTitle');
      const subtitleEl = document.getElementById('brandModalSubtitle');
      const listEl = document.getElementById('brandModalList');
      
      titleEl.textContent = title;
      subtitleEl.textContent = subtitle;
      
      // Render brand list
      listEl.innerHTML = brands.map(brand => `
        <li class="brand-list-item">
          <div class="brand-name">${escapeHtml(brand.name)}</div>
          <div class="brand-category">${escapeHtml(brand.category || '')}</div>
          ${brand.positioning ? `<div class="brand-positioning">${escapeHtml(brand.positioning)}</div>` : ''}
          ${brand.ad_url ? `<div class="brand-ad-link"><a href="${escapeHtml(brand.ad_url)}" target="_blank" rel="noopener">ğŸ”— View exact ad</a></div>` : ''}
        </li>
      `).join('');
      
      modal.classList.add('active');
    }

    function closeBrandModal(event) {
      const modal = document.getElementById('brandModal');
      modal.classList.remove('active');
    }

    function toggleNewsCard(cardId) {
      const card = document.getElementById(cardId);
      if (!card) return;
      
      const collapsed = card.classList.toggle('collapsed');
      localStorage.setItem('newsCard_' + cardId, collapsed ? 'collapsed' : 'expanded');
    }

    function copyCardContent(event, listId, cardName) {
      event.stopPropagation(); // Prevent card toggle when clicking copy button
      
      const list = document.getElementById(listId);
      if (!list) {
        showStatus('âŒ Nothing to copy', 'error');
        return;
      }

      const items = Array.from(list.querySelectorAll('li'));
      if (items.length === 0) {
        showStatus('âŒ No content to copy', 'error');
        return;
      }

      const text = items.map(li => {
        // For links, get the text content
        const link = li.querySelector('a');
        if (link) return link.href;
        return li.textContent.trim();
      }).join('\\n');

      navigator.clipboard.writeText(text).then(() => {
        showStatus(`âœ… ${cardName} copied!`, 'success');
      }).catch(err => {
        showStatus('âŒ Failed to copy', 'error');
      });
    }

    function initNewsCards() {
      const cardIds = [
        'popularHooksCard',
        'popularAnglesCard',
        'popularThemesCard',
        'compliancePatternsCard',
        'trendingAdsCard',
        'adLinksCard',
        'scraperRunsCard'
      ];

      cardIds.forEach(cardId => {
        const card = document.getElementById(cardId);
        if (!card) return;

        // Set initial state from localStorage (default collapsed for compact view)
        const savedState = localStorage.getItem('newsCard_' + cardId);
        if (savedState === 'expanded') {
          card.classList.remove('collapsed');
        } else {
          card.classList.add('collapsed');
        }

        // Add click handler on the card itself (but not on buttons)
        card.addEventListener('click', (e) => {
          // Don't toggle if clicking a button or link
          if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.closest('button')) {
            return;
          }
          toggleNewsCard(cardId);
        });
      });
    }

    async function changePeriod() {
      await loadCompetitorNews();
    }

    async function loadCompetitorNews() {
      const statusEl = document.getElementById('competitorNewsStatus');
      const metaEl = document.getElementById('competitorNewsMeta');
      const trendEl = document.getElementById('trendIndicators');
      const period = document.getElementById('periodSelector')?.value || 'current';
      const sortMode = document.getElementById('popularitySort')?.value || 'default';

      if (statusEl) statusEl.textContent = 'Loading insights...';
      if (trendEl) trendEl.style.display = 'none';

      try {
        // Load current or historical data based on period selection
        let data;
        
        if (period === 'current') {
          const res = await fetch('/api/competitor-news');
          if (!res.ok) throw new Error('Failed to load competitor insights');
          data = await res.json();
          
          const metaParts = [
            `Last updated: ${formatDateTime(data.lastUpdated)}`,
            `Companies: ${data.companyCount || 0}`,
            `Scrape runs: ${data.scrapeCount || 0}`
          ];
          if (data.sources && data.sources.length) {
            metaParts.push(`Sources: ${data.sources.join(', ')}`);
          }
          if (metaEl) metaEl.textContent = metaParts.join(' | ');
          if (statusEl) statusEl.textContent = 'Insights loaded (Live)';

          // Populate brand mappings for click-to-reveal functionality
          if (data.hookMapping) {
            BRAND_MAPPINGS.hooks = data.hookMapping || {};
            BRAND_MAPPINGS.angles = data.angleMapping || {};
            BRAND_MAPPINGS.compliance = data.complianceMapping || {};
            BRAND_MAPPINGS.trending = data.hookMapping || {}; // Trending phrases use same mapping as hooks
          }

          const hookItems = (data.popularHooks || []).map(hook => {
            const brands = (data.hookMapping && data.hookMapping[hook]) ? data.hookMapping[hook] : [];
            const adUrl = brands.find(b => b.ad_url)?.ad_url || null;
            return { text: hook, count: brands.length, ad_url: adUrl };
          });

          const angleItems = (data.popularAngles || []).map(angle => {
            const brands = (data.angleMapping && data.angleMapping[angle]) ? data.angleMapping[angle] : [];
            const adUrl = brands.find(b => b.ad_url)?.ad_url || null;
            return { text: angle, count: brands.length, ad_url: adUrl };
          });

          if (sortMode === 'popularity') {
            hookItems.sort((a, b) => (b.count || 0) - (a.count || 0));
            angleItems.sort((a, b) => (b.count || 0) - (a.count || 0));
          }

          renderList('popularHooksList', hookItems, 'No hooks captured yet.');
          renderList('popularAnglesList', angleItems, 'No angles captured yet.');
          renderList('popularThemesList', data.popularThemes, 'No themes captured yet.');
          renderList('compliancePatternsList', data.compliancePatterns, 'No compliance patterns yet.');

          const trending = (data.trendingAds || []).map(item => `${item.phrase} (${item.count}x)`);
          renderList('trendingAdsList', trending, 'No ad phrases captured yet.');

          const runs = (data.scraperRuns || []).map((run, idx) => {
            const status = run.success ? 'âœ… OK' : 'âŒ Fail';
            const updates = typeof run.updatesFound === 'number' ? `${run.updatesFound} updates` : '0 updates';
            const duration = run.duration ? `${run.duration}s` : '?s';
            const errorInfo = run.errors && run.errors.length > 0 ? `\nâŒ Errors: ${run.errors.join(', ')}` : '';
            // Format timestamp with fallback
            let timeStr = 'Unknown time';
            if (run.formattedTime) {
              timeStr = run.formattedTime;
            } else if (run.timestamp) {
              const d = new Date(run.timestamp);
              timeStr = d.toLocaleString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            }
            const details = `Status: ${status}\nUpdates: ${updates}\nDuration: ${duration}${errorInfo}`;
            return { 
              text: `${timeStr} - ${status} - ${updates} (${duration})`,
              details: details,
              id: `scraper-run-${idx}`
            };
          });
          
          // Render scraper runs with expandable details
          const scraperRunsEl = document.getElementById('scraperRunsList');
          if (scraperRunsEl) {
            if (!runs || runs.length === 0) {
              scraperRunsEl.innerHTML = '<li><span class="news-list-item-content">No scraper runs yet.</span></li>';
            } else {
              scraperRunsEl.innerHTML = runs.map(run => `
                <li style="padding: 0; border: none; background: none; margin-bottom: 6px;">
                  <div style="display: flex; gap: 8px; padding: 12px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #667eea; cursor: pointer; transition: all 0.2s;" 
                       onclick="toggleScraperRunDetails(event, '${run.id}')">
                    <span class="expand-icon" id="icon-${run.id}" style="font-size: 0.8rem; flex-shrink: 0;">â–¶</span>
                    <span class="news-list-item-content" style="flex: 1; margin: 0; user-select: none;">${escapeHtml(run.text)}</span>
                    <button class="copy-item-btn" style="flex-shrink: 0;" onclick="event.stopPropagation(); copyToClipboard('${run.text}')">ğŸ“‹</button>
                  </div>
                  <div id="details-${run.id}" style="display: none; padding: 12px 0 0 32px; font-size: 0.85rem; color: #666; white-space: pre-wrap; line-height: 1.5;">
                    ${escapeHtml(run.details)}
                  </div>
                </li>
              `).join('');
            }
          }

          const adLinksEl = document.getElementById('adLinksList');
          if (adLinksEl) {
            if (!data.linksAvailable) {
              adLinksEl.innerHTML = '<li><span class="news-list-item-content">No ad links captured yet. Add links to data/competitors.json.</span></li>';
            } else {
              const items = [];
              
              // Add REAL extracted ads first (higher priority)
              if (data.realAdLinks && data.realAdLinks.length > 0) {
                items.push('<li style="background: #f0f7ff; padding: 10px; border-radius: 6px; margin-bottom: 10px;"><strong style="color: #667eea;">ğŸ”¥ REAL EXTRACTED ADS FROM FACEBOOK:</strong></li>');
                (data.realAdLinks || []).forEach((company, companyIdx) => {
                  const companyId = `company_${companyIdx}`;
                  items.push(`<li style="margin-left: 20px; margin-bottom: 8px;"><strong>${escapeHtml(company.name)}</strong> (${company.adCount} real ads found)</li>`);
                  
                  const allAds = company.ads || [];
                  const showCount = 10;
                  
                  // Show first 10 ads
                  allAds.slice(0, showCount).forEach(ad => {
                    const libId = ad.library_id || 'unknown';
                    const url = ad.ad_url || '#';
                    items.push(`
                      <li style="margin-left: 40px; margin-bottom: 4px;">
                        <span class="news-list-item-content"><a href="${url}" target="_blank" rel="noopener"><code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px;">${escapeHtml(libId)}</code></a></span>
                        <button class="copy-item-btn" onclick="copyToClipboard('${url}')">ğŸ“‹</button>
                      </li>
                    `);
                  });
                  
                  // Hidden ads container
                  if (allAds.length > showCount) {
                    items.push(`<li id="hidden_${companyId}" style="display: none; margin-left: 40px;">`);
                    allAds.slice(showCount).forEach(ad => {
                      const libId = ad.library_id || 'unknown';
                      const url = ad.ad_url || '#';
                      items.push(`
                        <div style="margin-bottom: 4px;">
                          <span class="news-list-item-content"><a href="${url}" target="_blank" rel="noopener"><code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px;">${escapeHtml(libId)}</code></a></span>
                          <button class="copy-item-btn" onclick="copyToClipboard('${url}')">ğŸ“‹</button>
                        </div>
                      `);
                    });
                    items.push(`</li>`);
                    
                    // Show more button
                    items.push(`
                      <li style="margin-left: 40px; margin-bottom: 8px;">
                        <button onclick="toggleMoreAds('${companyId}', event)" style="
                          background: none;
                          border: none;
                          color: #667eea;
                          cursor: pointer;
                          font-weight: 500;
                          padding: 4px 8px;
                          text-decoration: underline;
                          font-size: 0.95rem;
                        ">+${allAds.length - showCount} more ads â–¼</button>
                      </li>
                    `);
                  }
                });
                items.push('<li style="height: 1px; background: #ddd; margin: 15px 0;"></li>');
              }
              
              // Add template links as reference
              if ((data.adLinks || []).length > 0) {
                items.push('<li style="padding: 10px; margin-bottom: 10px;"><strong style="color: #666;">ğŸ“Œ Template Ad Library Links:</strong></li>');
                (data.adLinks || []).forEach(company => {
                  (company.links || []).forEach(link => {
                    items.push(`
                      <li style="margin-left: 20px;">
                        <span class="news-list-item-content"><a href="${link}" target="_blank" rel="noopener">${escapeHtml(company.name)} - Ad Library</a></span>
                        <button class="copy-item-btn" onclick="copyListItem(event, this)">ğŸ“‹</button>
                      </li>
                    `);
                  });
                });
              }
              
              adLinksEl.innerHTML = items.length ? items.join('') : '<li><span class="news-list-item-content">No ad links captured yet.</span></li>';
            }
          }
          
          // Toggle more ads function
          function toggleMoreAds(companyId, event) {
            event.preventDefault();
            event.stopPropagation();
            const hiddenEl = document.getElementById(`hidden_${companyId}`);
            const btn = event.target;
            if (hiddenEl) {
              const isHidden = hiddenEl.style.display === 'none';
              hiddenEl.style.display = isHidden ? 'block' : 'none';
              btn.textContent = isHidden ? btn.textContent.replace('â–¼', 'â–²') : btn.textContent.replace('â–²', 'â–¼');
            }
          }
          
          // Load trends for comparison
          try {
            const trendsRes = await fetch('/api/competitor-trends');
            if (trendsRes.ok) {
              const trends = await trendsRes.json();
              if (trends.changes && (trends.changes.hooks_delta !== 0 || trends.changes.angles_delta !== 0)) {
                const hooksChange = trends.changes.hooks_delta > 0 ? `â†‘ +${trends.changes.hooks_delta}` : trends.changes.hooks_delta < 0 ? `â†“ ${trends.changes.hooks_delta}` : 'â†’ 0';
                const anglesChange = trends.changes.angles_delta > 0 ? `â†‘ +${trends.changes.angles_delta}` : trends.changes.angles_delta < 0 ? `â†“ ${trends.changes.angles_delta}` : 'â†’ 0';
                
                if (trendEl) {
                  trendEl.innerHTML = `<strong>Week-over-Week:</strong> Hooks ${hooksChange} | Angles ${anglesChange}`;
                  if (trends.changes.new_hooks && trends.changes.new_hooks.length > 0) {
                    trendEl.innerHTML += ` | <span style="color: #667eea;">${trends.changes.new_hooks.length} new hook(s)</span>`;
                  }
                  trendEl.style.display = 'block';
                }
              }
            }
          } catch (e) {
            // Trends optional, don't fail
          }
          
        } else {
          // Historical view
          const res = await fetch(`/api/competitor-history/${period}`);
          if (!res.ok) throw new Error('Failed to load historical data');
          const histData = await res.json();
          
          if (!histData.data) {
            if (statusEl) statusEl.textContent = 'No historical data available yet';
            if (metaEl) metaEl.textContent = 'Historical tracking started. Data will accumulate over time.';
            renderList('popularHooksList', [], 'No hooks captured for this period yet.');
            renderList('popularAnglesList', [], 'No angles captured for this period yet.');
            renderList('popularThemesList', [], 'No themes tracked yet.');
            renderList('compliancePatternsList', [], 'No compliance patterns yet.');
            renderList('trendingAdsList', [], 'No ad phrases captured yet.');
            renderList('scraperRunsList', [], 'No scraper runs yet.');
            const adLinksEl = document.getElementById('adLinksList');
            if (adLinksEl) adLinksEl.innerHTML = '<li>No ad links captured yet.</li>';
            return;
          }
          
          const periodData = histData.data;
          const periodLabel = period.charAt(0).toUpperCase() + period.slice(1);
          
          if (metaEl) {
            metaEl.textContent = `Period: ${periodLabel} | Unique Hooks: ${periodData.total_hooks || 0} | Unique Angles: ${periodData.total_angles || 0}`;
          }
          if (statusEl) statusEl.textContent = `Historical view (${periodLabel})`;
          
          renderList('popularHooksList', periodData.unique_hooks || [], 'No hooks captured for this period.');
          renderList('popularAnglesList', periodData.unique_angles || [], 'No angles captured for this period.');
          renderList('popularThemesList', [], 'Theme tracking coming soon.');
          renderList('compliancePatternsList', [], 'Compliance tracking coming soon.');
          renderList('trendingAdsList', [], 'Historical ad phrases coming soon.');
          
          // Show daily/monthly summaries
          if (periodData.daily_summaries && periodData.daily_summaries.length > 0) {
            const summaries = periodData.daily_summaries.map(s => 
              `${s.date}: ${s.hooks} hooks, ${s.angles} angles`
            );
            renderList('scraperRunsList', summaries, 'No summary data.');
          } else if (periodData.monthly_summaries && periodData.monthly_summaries.length > 0) {
            const summaries = periodData.monthly_summaries.map(s => 
              `${s.month}: ${s.hooks} hooks, ${s.angles} angles`
            );
            renderList('scraperRunsList', summaries, 'No summary data.');
          } else {
            renderList('scraperRunsList', [], 'No summary data yet.');
          }
          
          const adLinksEl = document.getElementById('adLinksList');
          if (adLinksEl) adLinksEl.innerHTML = '<li><span class="news-list-item-content">Historical ad links coming soon.</span></li>';
        }
        
      } catch (err) {
        if (statusEl) statusEl.textContent = 'Unable to load insights.';
        if (metaEl) metaEl.textContent = '';
        renderList('popularHooksList', [], 'No hooks captured yet.');
        renderList('popularAnglesList', [], 'No angles captured yet.');
        renderList('popularThemesList', [], 'No themes captured yet.');
        renderList('compliancePatternsList', [], 'No compliance patterns yet.');
        renderList('trendingAdsList', [], 'No ad phrases captured yet.');
        renderList('scraperRunsList', [], 'No scraper runs yet.');
        const adLinksEl = document.getElementById('adLinksList');
        if (adLinksEl) adLinksEl.innerHTML = '<li><span class="news-list-item-content">No ad links captured yet.</span></li>';
      }
    }

    // â”€â”€â”€ ANALYZE AD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function analyzeAd() {
      const fileInput = document.getElementById('adImageUpload');
      const file = fileInput.files[0];
      const productName = document.getElementById('adProductName').value.trim();
      const productContext = document.getElementById('adProductContext').value.trim();
      
      if (!file) {
        showStatus('Please select an image first', 'error');
        return;
      }
      
      if (!productName || !productContext) {
        showStatus('Please fill in your product name and context', 'error');
        return;
      }
      
      const btn = event.target;
      btn.disabled = true;
      const originalText = btn.textContent;
      btn.innerHTML = '<span class="spinner"></span>Analyzing with Ollama Vision...';
      
      try {
        showStatus('ğŸ¤– Ollama Vision analyzing competitor ad...', 'loading');
        
        const formData = new FormData();
        formData.append('image', file);
        
        const res = await fetch('/api/analyze-ad', {
          method: 'POST',
          body: formData
        });
        
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error);
        }
        
        const data = await res.json();
        
        // Store analysis
        S.adAnalysis = data.analysis;
        
        // Display analysis
        document.getElementById('adAnalysisText').textContent = data.analysis;
        document.getElementById('adAnalysisResult').style.display = 'block';
        
        showStatus('âœ… Ad analyzed! Now generating hooks...', 'success');
        
        // Automatically generate hooks inspired by the ad
        await generateHooksFromAd(productName, productContext, data.analysis);
        
        btn.disabled = false;
        btn.innerHTML = originalText;
      } catch (err) {
        showStatus('âŒ ' + err.message, 'error');
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // â”€â”€â”€ GENERATE HOOKS FROM AD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function generateHooksFromAd(productName, productContext, adAnalysis) {
      try {
        showStatus('ğŸ¯ Generating Meta-compliant hooks...', 'loading');
        
        const res = await fetch('/api/generate-hooks-from-ad', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productName, productContext, adAnalysis })
        });
        
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error);
        }
        
        const data = await res.json();
        
        // Store hooks and visual theme
        S.adInspiredHooks = data.hooks;
        S.adVisualTheme = data.visualTheme;
        
        // Render the hooks
        renderAdInspiredHooks();
        
        document.getElementById('adInspiredHooksSection').style.display = 'block';
        showStatus('âœ… 5 hooks generated! Click any to create Whisk prompt.', 'success');
        
        // Scroll to hooks
        document.getElementById('adInspiredHooksSection').scrollIntoView({ behavior: 'smooth' });
      } catch (err) {
        showStatus('âŒ ' + err.message, 'error');
      }
    }

    // â”€â”€â”€ RENDER AD-INSPIRED HOOKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderAdInspiredHooks() {
      const grid = document.getElementById('adInspiredHooksGrid');
      grid.innerHTML = S.adInspiredHooks.map((hook, idx) => `
        <div class="hook-card" style="background: white; border-left: 4px solid #fcb69f;">
          <div class="hook-text">${hook}</div>
          <div class="hook-actions">
            <button class="hook-btn" data-hook="${hook}" data-index="${idx}" onclick="copyAdHook(this)">
              ğŸ“‹ Copy
            </button>
            <button class="hook-btn" data-hook="${hook}" onclick="showAdHookAspectRatioSelector(this)" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
              ğŸ¨ Whisk
            </button>
          </div>
        </div>
      `).join('');
    }

    // â”€â”€â”€ COPY AD HOOK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function copyAdHook(btn) {
      const hook = btn.getAttribute('data-hook');
      navigator.clipboard.writeText(hook);
      showStatus('âœ… Hook copied!', 'success');
    }

    // â”€â”€â”€ SHOW AD HOOK ASPECT RATIO SELECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showAdHookAspectRatioSelector(btn) {
      const hook = btn.getAttribute('data-hook');
      S.currentHook = hook;
      const modalBody = document.getElementById('modalBody');
      modalBody.innerHTML = `
        <h2>Select Image Format</h2>
        <p style="color: #666; margin: 15px 0; font-size: 0.95rem;">Choose the aspect ratio for your Whisk image (with competitor visual style):</p>
        <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 20px;">
          <button class="btn-submit" onclick="generateImagePromptWithTheme(S.currentHook, '4:5')" style="padding: 20px;">
            ğŸ“± 4:5 (Instagram/Facebook Feed & Reels)
            <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 5px;">1080x1350px - Vertical format</div>
          </button>
          <button class="btn-submit" onclick="generateImagePromptWithTheme(S.currentHook, '9:16')" style="padding: 20px;">
            ğŸ“² 9:16 (TikTok/Stories)
            <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 5px;">1080x1920px - Tall vertical format</div>
          </button>
          <button class="btn-submit" onclick="generateImagePromptWithTheme(S.currentHook, 'both')" style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            ğŸ¯ Both Formats
            <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 5px;">Generate prompts for both sizes</div>
          </button>
        </div>
      `;
      document.getElementById('modal').style.display = 'flex';
    }

    // â”€â”€â”€ GENERATE IMAGE PROMPT WITH THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function generateImagePromptWithTheme(hook, aspectRatio) {
      const productName = document.getElementById('adProductName').value.trim();
      
      const modal = document.getElementById('modal');
      modal.style.display = 'none';
      
      try {
        showStatus('ğŸ¨ Creating visual prompt matching competitor style...', 'loading');
        
        const res = await fetch('/api/generate-image-prompt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            productName,
            hook,
            angle: 'Ad-Inspired',
            aspectRatio,
            visualTheme: S.adVisualTheme
          })
        });
        
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error);
        }
        
        const data = await res.json();
        
        if (aspectRatio === 'both') {
          S.currentImagePrompt = data.prompts;
          showImagePromptModal(data.prompts, data.whiskUrl, true);
        } else {
          S.currentImagePrompt = data.imagePrompt;
          showImagePromptModal(data.imagePrompt, data.whiskUrl, false, data.aspectRatio);
        }
        
        S.currentHook = hook;
        showStatus('âœ… Whisk prompt generated!', 'success');
      } catch (err) {
        showStatus('âŒ ' + err.message, 'error');
      }
    }

    // â”€â”€â”€ GENERATE INSPIRED ANGLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â”€â”€â”€ GENERATE ANGLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function generateAngles() {
      const prodName = document.getElementById('productName').value.trim();
      const prodContext = document.getElementById('productContext').value.trim();

      if (!prodName || !prodContext) {
        showStatus('Fill in product name and context', 'error');
        return;
      }

      S.productName = prodName;
      S.productContext = prodContext;

      const btn = event.target;
      btn.disabled = true;
      const originalText = btn.textContent;
      btn.innerHTML = '<span class="spinner"></span>Generating angles...';

      try {
        showStatus('âœ¨ Generating 3 angles...', 'loading');
        const model = document.querySelector('input[name="model"]:checked').value || 'ollama';

        const res = await fetch('/api/generate-angles', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productName: prodName, productContext: prodContext, model })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error);
        }

        const data = await res.json();
        S.angles = data.angles;

        showStatus('âœ… Angles generated!', 'success');
        renderAngles();
        document.getElementById('anglesSection').style.display = 'block';

        // Save to history
        saveToHistory();

        btn.disabled = false;
        btn.textContent = originalText;
        
        // Scroll to angles
        setTimeout(() => {
          document.getElementById('anglesSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 300);
      } catch (err) {
        showStatus('âŒ ' + err.message, 'error');
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    // â”€â”€â”€ RENDER ANGLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderAngles() {
      const grid = document.getElementById('anglesGrid');
      grid.innerHTML = '';

      S.angles.forEach((angle, idx) => {
        const wrapper = document.createElement('div');
        wrapper.style.cssText = 'display: flex; gap: 8px; align-items: center; margin-bottom: 10px;';
        
        const btn = document.createElement('button');
        btn.className = 'angle-btn';
        btn.textContent = angle;
        if (S.selectedAngle === angle) btn.classList.add('active');
        btn.onclick = () => selectAngle(angle, btn);
        
        const editBtn = document.createElement('button');
        editBtn.textContent = 'âœï¸ Edit';
        editBtn.className = 'hook-btn';
        editBtn.style.cssText = 'padding: 8px 12px; font-size: 0.85rem;';
        editBtn.onclick = (e) => {
          e.stopPropagation();
          showEditAngleModal(idx);
        };
        
        wrapper.appendChild(btn);
        wrapper.appendChild(editBtn);
        grid.appendChild(wrapper);
      });
    }

    // â”€â”€â”€ SELECT ANGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function selectAngle(angle, btnElement) {
      S.selectedAngle = angle;
      
      // Update active button
      document.querySelectorAll('.angle-btn').forEach(btn => btn.classList.remove('active'));
      btnElement.classList.add('active');

      btnElement.disabled = true;
      const originalText = btnElement.textContent;
      btnElement.innerHTML = '<span class="spinner"></span>' + originalText;

      try {
        showStatus('ğŸ¯ Generating hooks...', 'loading');
        const model = document.querySelector('input[name="model"]:checked').value || 'ollama';

        const res = await fetch('/api/generate-hooks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            productName: S.productName,
            productContext: S.productContext,
            angle: angle,
            model
          })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error);
        }

        const data = await res.json();
        S.hooks = data.hooks;

        showStatus('âœ… Hooks generated!', 'success');
        renderHooks();
        document.getElementById('hooksSection').style.display = 'block';
        document.getElementById('selectedAngleDisplay').textContent = angle;

        // Save to history
        saveToHistory();

        btnElement.disabled = false;
        btnElement.textContent = originalText;
        
        // Scroll to hooks
        setTimeout(() => {
          document.getElementById('hooksSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 300);
      } catch (err) {
        showStatus('âŒ ' + err.message, 'error');
        btnElement.disabled = false;
        btnElement.textContent = originalText;
      }
    }

    // â”€â”€â”€ RENDER HOOKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderHooks() {
      const grid = document.getElementById('hooksGrid');
      grid.innerHTML = '';

      S.hooks.forEach((hook, idx) => {
        const card = document.createElement('div');
        card.className = 'hook-card';
        card.innerHTML = `
          <div class="copy-badge">Hover for actions</div>
          <div class="hook-text">${escapeHtml(hook)}</div>
          <div class="hook-label">Hook ${idx + 1}</div>
          <div class="hook-actions">
            <button class="hook-btn hook-copy-btn" data-hook-idx="${idx}">ğŸ“‹ Copy</button>
            <button class="hook-btn hook-whisk-btn" data-hook-idx="${idx}">ğŸ¨ Whisk</button>
            <button class="hook-btn hook-edit-btn" data-hook-idx="${idx}">âœï¸ Edit</button>
          </div>
        `;
        grid.appendChild(card);
      });
      
      // Attach event listeners to all buttons
      document.querySelectorAll('.hook-copy-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.hookIdx);
          copyHook(S.hooks[idx]);
        });
      });
      
      document.querySelectorAll('.hook-whisk-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.hookIdx);
          generateWhiskPrompts(S.hooks[idx]);
        });
      });
      
      document.querySelectorAll('.hook-edit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.hookIdx);
          showEditHookModal(idx);
        });
      });
    }

    // â”€â”€â”€ COPY HOOK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function copyHook(hook) {
      navigator.clipboard.writeText(hook).then(() => {
        showStatus('âœ… Copied to clipboard!', 'success');
      });
    }

    // â”€â”€â”€ WHISK PROMPTS STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const WHISK_STATE = {
      selectedHook: '',
      selectedAngle: '',
      prompts: {
        surreal: '',
        'out-of-box': '',
        basic: ''
      }
    };

    // â”€â”€â”€ GENERATE WHISK PROMPTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function generateWhiskPrompts(hook) {
      if (!S.selectedAngle) {
        showStatus('âŒ Select an angle first', 'error');
        return;
      }

      const btn = event.target;
      btn.disabled = true;
      const originalText = btn.textContent;
      btn.innerHTML = '<span class="spinner"></span>Generating...';

      WHISK_STATE.selectedHook = hook;
      WHISK_STATE.selectedAngle = S.selectedAngle;

      try {
        showStatus('ğŸ¨ Generating 3 Whisk prompt styles...', 'loading');
        const model = document.querySelector('input[name="model"]:checked').value || 'ollama';

        const res = await fetch('/api/generate-whisk-prompts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            angle: S.selectedAngle,
            hook: hook,
            productName: S.productName,
            productContext: S.productContext,
            model
          })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error);
        }

        const data = await res.json();
        WHISK_STATE.prompts = {
          surreal: data.surreal,
          'out-of-box': data.outOfBox,
          basic: data.basic
        };

        showStatus('âœ… Prompts generated!', 'success');
        renderWhiskPrompts();
        document.getElementById('whiskSection').style.display = 'block';
        document.getElementById('whiskHistorySection').style.display = 'block';
        
        // Scroll to prompts
        setTimeout(() => {
          document.getElementById('whiskSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 300);

        btn.disabled = false;
        btn.textContent = originalText;
      } catch (err) {
        showStatus('âŒ ' + err.message, 'error');
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    // â”€â”€â”€ RENDER WHISK PROMPTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderWhiskPrompts() {
      document.getElementById('whiskAngleDisplay').textContent = WHISK_STATE.selectedAngle;
      document.getElementById('whiskHookDisplay').textContent = WHISK_STATE.selectedHook;

      ['surreal', 'out-of-box', 'basic'].forEach(style => {
        const textEl = document.getElementById(`${style}-text`);
        textEl.textContent = WHISK_STATE.prompts[style];
      });

      renderWhiskHistory();
    }

    // â”€â”€â”€ COPY WHISK PROMPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function copyPrompt(style) {
      const text = WHISK_STATE.prompts[style];
      navigator.clipboard.writeText(text).then(() => {
        showStatus('âœ… Prompt copied to clipboard!', 'success');
      });
    }

    // â”€â”€â”€ COPY ALL WHISK PROMPTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function copyAllWhiskPrompts() {
      const all = `
[SURREAL]
${WHISK_STATE.prompts.surreal}

[OUT-OF-BOX]
${WHISK_STATE.prompts['out-of-box']}

[BASIC]
${WHISK_STATE.prompts.basic}
      `.trim();
      navigator.clipboard.writeText(all).then(() => {
        showStatus('âœ… All prompts copied!', 'success');
      });
    }

    // â”€â”€â”€ EDIT PROMPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function editPrompt(style) {
      const modalBody = document.getElementById('modalBody');
      modalBody.innerHTML = `
        <h2>âœï¸ Edit ${style.toUpperCase()} Prompt</h2>
        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #667eea; max-height: 150px; overflow-y: auto;">
          <strong>Original:</strong><br>
          ${escapeHtml(WHISK_STATE.prompts[style])}
        </div>
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Your edits:</label>
        <textarea id="editPromptText" style="width: 100%; height: 150px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; margin-bottom: 15px; resize: vertical; font-family: monospace;">${WHISK_STATE.prompts[style]}</textarea>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn-submit" onclick="saveEditedPrompt('${style}')">ğŸ’¾ Save Changes</button>
          <button class="btn-submit" style="background: #666;" onclick="closeModal()">â† Back</button>
        </div>
      `;
      document.getElementById('modal').style.display = 'flex';
    }

    // â”€â”€â”€ SAVE EDITED PROMPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function saveEditedPrompt(style) {
      const newText = document.getElementById('editPromptText').value.trim();
      if (!newText) {
        showStatus('âŒ Prompt cannot be empty', 'error');
        return;
      }
      WHISK_STATE.prompts[style] = newText;
      renderWhiskPrompts();
      document.getElementById('modal').style.display = 'none';
      showStatus('âœ… Prompt updated!', 'success');
    }

    // â”€â”€â”€ REGENERATE PROMPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function regeneratePrompt(style) {
      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Regen...';

      try {
        const model = document.querySelector('input[name="model"]:checked').value || 'ollama';
        showStatus(`ğŸ¨ Regenerating ${style} prompt with ${model.toUpperCase()}...`, 'loading');

        const res = await fetch('/api/regenerate-whisk-prompt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            style: style,
            angle: WHISK_STATE.selectedAngle,
            hook: WHISK_STATE.selectedHook,
            productName: S.productName,
            model
          })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error);
        }

        const data = await res.json();
        WHISK_STATE.prompts[style] = data.prompt;
        
        showStatus('âœ… Prompt regenerated!', 'success');
        renderWhiskPrompts();

        btn.disabled = false;
        btn.innerHTML = 'ğŸ”„ Regen';
      } catch (err) {
        showStatus('âŒ ' + err.message, 'error');
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”„ Regen';
      }
    }

    // â”€â”€â”€ SAVE WHISK PROMPT TO HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function saveWhiskPromptToHistory() {
      const history = JSON.parse(localStorage.getItem('whiskPromptHistory') || '[]');
      
      const entry = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        angle: WHISK_STATE.selectedAngle,
        hook: WHISK_STATE.selectedHook,
        prompts: { ...WHISK_STATE.prompts },
        productName: S.productName
      };
      
      history.unshift(entry);
      
      // Keep last 50 entries
      if (history.length > 50) history.pop();
      
      localStorage.setItem('whiskPromptHistory', JSON.stringify(history));
      showStatus('âœ… Saved to history!', 'success');
      renderWhiskHistory();
    }

    // â”€â”€â”€ RENDER WHISK HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderWhiskHistory() {
      const history = JSON.parse(localStorage.getItem('whiskPromptHistory') || '[]');
      const container = document.getElementById('whiskHistoryContainer');
      
      if (history.length === 0) {
        container.innerHTML = '<p style="color: #999; grid-column: 1/-1; text-align: center; padding: 30px;">No saved workflows yet. Create one and save it!</p>';
        return;
      }

      container.innerHTML = history.map((entry, idx) => {
        const date = new Date(entry.timestamp);
        const timeAgo = getTimeAgo(date);
        
        return `
          <div style="background: white; border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; transition: all 0.3s;"
               onmouseover="this.style.borderColor='#667eea'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.15)'"
               onmouseout="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
              <div style="flex: 1;">
                <div style="font-weight: 600; color: #333; font-size: 0.95rem;">ğŸ“Œ ${escapeHtml(entry.angle.substring(0, 40))}</div>
                <div style="font-size: 0.85rem; color: #666; margin-top: 4px;">ğŸ¯ ${escapeHtml(entry.hook.substring(0, 40))}</div>
                <div style="font-size: 0.8rem; color: #999; margin-top: 4px;">${timeAgo}</div>
              </div>
              <button onclick="loadWhiskHistoryEntry(${entry.id})" 
                      style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; white-space: nowrap;"
                      onmouseover="this.style.background='#764ba2'"
                      onmouseout="this.style.background='#667eea'">
                ğŸ“‚ Load
              </button>
            </div>
            <div style="display: flex; gap: 4px; margin-bottom: 10px;">
              <span style="background: #f0f0f0; padding: 3px 8px; border-radius: 3px; font-size: 0.75rem;">ğŸŒ€ Surreal</span>
              <span style="background: #f0f0f0; padding: 3px 8px; border-radius: 3px; font-size: 0.75rem;">ğŸ’¡ OOB</span>
              <span style="background: #f0f0f0; padding: 3px 8px; border-radius: 3px; font-size: 0.75rem;">ğŸ“ Basic</span>
            </div>
            <button onclick="deleteWhiskHistoryEntry(${entry.id})" 
                    style="background: #ff4d4f; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; width: 100%; margin-top: 8px;"
                    onmouseover="this.style.background='#ff7875'"
                    onmouseout="this.style.background='#ff4d4f'">
              ğŸ—‘ï¸ Delete
            </button>
          </div>
        `;
      }).join('');
    }

    // â”€â”€â”€ LOAD WHISK HISTORY ENTRY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function loadWhiskHistoryEntry(entryId) {
      const history = JSON.parse(localStorage.getItem('whiskPromptHistory') || '[]');
      const entry = history.find(e => e.id === entryId);
      
      if (!entry) {
        showStatus('âŒ Entry not found', 'error');
        return;
      }

      WHISK_STATE.selectedAngle = entry.angle;
      WHISK_STATE.selectedHook = entry.hook;
      WHISK_STATE.prompts = { ...entry.prompts };
      
      renderWhiskPrompts();
      document.getElementById('whiskSection').scrollIntoView({ behavior: 'smooth' });
      showStatus('âœ… Workflow loaded!', 'success');
    }

    // â”€â”€â”€ DELETE WHISK HISTORY ENTRY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function deleteWhiskHistoryEntry(entryId) {
      if (!confirm('Delete this workflow from history?')) return;
      
      let history = JSON.parse(localStorage.getItem('whiskPromptHistory') || '[]');
      history = history.filter(e => e.id !== entryId);
      localStorage.setItem('whiskPromptHistory', JSON.stringify(history));
      
      showStatus('âœ… Entry deleted!', 'success');
      renderWhiskHistory();
    }

    // â”€â”€â”€ CLEAR ALL WHISK HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function clearWhiskHistory() {
      if (!confirm('Delete ALL saved workflows? This cannot be undone.')) return;
      
      localStorage.removeItem('whiskPromptHistory');
      showStatus('âœ… History cleared!', 'success');
      renderWhiskHistory();
    }

    // â”€â”€â”€ OPEN WHISK WINDOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openWhiskWindow() {
      window.open('https://labs.google/fx/tools/whisk/project', 'whisk_popup', 'width=1200,height=800,left=100,top=100,resizable=yes,scrollbars=yes');
    }

    // â”€â”€â”€ SHOW ASPECT RATIO SELECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showAspectRatioSelector(hook) {
      S.currentHook = hook;
      const modalBody = document.getElementById('modalBody');
      modalBody.innerHTML = `
        <h2>Select Image Format</h2>
        <p style="color: #666; margin: 15px 0; font-size: 0.95rem;">Choose the aspect ratio for your Whisk image:</p>
        <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 20px;">
          <button class="btn-submit" onclick="generateImagePrompt(S.currentHook, '4:5')" style="padding: 20px;">
            ğŸ“± 4:5 (Instagram/Facebook Feed & Reels)
            <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 5px;">1080x1350px - Vertical format</div>
          </button>
          <button class="btn-submit" onclick="generateImagePrompt(S.currentHook, '9:16')" style="padding: 20px;">
            ğŸ“² 9:16 (TikTok/Stories)
            <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 5px;">1080x1920px - Tall vertical format</div>
          </button>
          <button class="btn-submit" onclick="generateImagePrompt(S.currentHook, 'both')" style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            ğŸ¯ Both Formats
            <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 5px;">Generate prompts for both sizes</div>
          </button>
        </div>
      `;
      document.getElementById('modal').style.display = 'flex';
    }

    // â”€â”€â”€ GENERATE IMAGE PROMPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function generateImagePrompt(hook, aspectRatio) {
      try {
        showStatus('ğŸ¨ Creating Whisk prompt...', 'loading');

        const res = await fetch('/api/generate-image-prompt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            productName: S.productName,
            hook: hook,
            angle: S.selectedAngle,
            aspectRatio: aspectRatio
          })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error);
        }

        const data = await res.json();
        if (data.prompts) {
          // Handle "both" option with array of prompts
          showImagePromptModal(data.prompts, data.whiskUrl, true);
        } else {
          // Handle single prompt
          showImagePromptModal(data.imagePrompt, data.whiskUrl, false, data.aspectRatio);
        }
        showStatus('âœ… Whisk prompt ready!', 'success');
      } catch (err) {
        showStatus('âŒ ' + err.message, 'error');
      }
    }

    // â”€â”€â”€ SHOW IMAGE PROMPT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showImagePromptModal(imagePrompt, whiskUrl, isBoth = false, aspectRatio = '') {
      const modalBody = document.getElementById('modalBody');
      
      if (isBoth && Array.isArray(imagePrompt)) {
        // Handle "both" - show two prompts
        S.currentImagePrompt = imagePrompt; // Store array
        const prompt45 = imagePrompt.find(p => p.ratio === '4:5');
        const prompt916 = imagePrompt.find(p => p.ratio === '9:16');
        
        modalBody.innerHTML = `
          <h2>Whisk Image Prompts (Both Formats)</h2>
          <p style="color: #666; margin: 15px 0; font-size: 0.95rem;">Use these prompts with <a href="${whiskUrl}" target="_blank" style="color: #667eea; font-weight: 600;">Google Whisk</a> to generate your images.</p>
          
          <div style="margin-bottom: 25px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ“± 4:5 Format (Instagram/Facebook Feed)</h3>
            
            <div style="margin-bottom: 15px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <strong style="color: #333;">Whisk Prompt:</strong>
                <button class="btn-submit" onclick="copyPromptByRatio('4:5')" style="padding: 6px 12px; font-size: 0.85rem;">ğŸ“‹ Copy Whisk</button>
              </div>
              <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; line-height: 1.6; color: #333; border-left: 4px solid #667eea;">
                ${escapeHtml(prompt45?.imagePrompt || '')}
              </div>
            </div>
            
            <div style="margin-bottom: 15px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <strong style="color: #333;">Designer Brief (Easy Reading):</strong>
                <button class="btn-submit" onclick="copyDesignerBrief('${escapeHtml(prompt45?.imagePrompt || '').replace(/'/g, "&#39;")}')" style="padding: 6px 12px; font-size: 0.85rem; background: #52c41a;">ğŸ“‹ Copy Brief</button>
              </div>
              <div style="background: white; padding: 15px; border-radius: 8px; line-height: 1.8; color: #333; border: 2px solid #52c41a;">
                ${formatDesignerBrief(prompt45?.imagePrompt || '', '4:5')}
              </div>
            </div>
            
            <button class="btn-submit" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="openWhiskPopup('${whiskUrl}')">ğŸ¨ Open Whisk</button>
          </div>
          
          <div>
            <h3 style="color: #764ba2; margin-bottom: 10px;">ğŸ“² 9:16 Format (TikTok/Stories)</h3>
            
            <div style="margin-bottom: 15px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <strong style="color: #333;">Whisk Prompt:</strong>
                <button class="btn-submit" onclick="copyPromptByRatio('9:16')" style="padding: 6px 12px; font-size: 0.85rem;">ğŸ“‹ Copy Whisk</button>
              </div>
              <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; line-height: 1.6; color: #333; border-left: 4px solid #764ba2;">
                ${escapeHtml(prompt916?.imagePrompt || '')}
              </div>
            </div>
            
            <div style="margin-bottom: 15px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <strong style="color: #333;">Designer Brief (Easy Reading):</strong>
                <button class="btn-submit" onclick="copyDesignerBrief('${escapeHtml(prompt916?.imagePrompt || '').replace(/'/g, "&#39;")}')" style="padding: 6px 12px; font-size: 0.85rem; background: #52c41a;">ğŸ“‹ Copy Brief</button>
              </div>
              <div style="background: white; padding: 15px; border-radius: 8px; line-height: 1.8; color: #333; border: 2px solid #52c41a;">
                ${formatDesignerBrief(prompt916?.imagePrompt || '', '9:16')}
              </div>
            </div>
            
            <button class="btn-submit" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="openWhiskPopup('${whiskUrl}')">ğŸ¨ Open Whisk</button>
          </div>
        `;
      } else {
        // Handle single prompt
        S.currentImagePrompt = imagePrompt;
        const ratioLabel = aspectRatio === '4:5' ? ' (4:5 Format)' : aspectRatio === '9:16' ? ' (9:16 Format)' : '';
        const designerBrief = formatDesignerBrief(imagePrompt, aspectRatio);
        
        modalBody.innerHTML = `
          <h2>Whisk Image Prompt${ratioLabel}</h2>
          <p style="color: #666; margin: 15px 0; font-size: 0.95rem;">Use this prompt with <a href="${whiskUrl}" target="_blank" style="color: #667eea; font-weight: 600;">Google Whisk</a> to generate your image.</p>
          
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <strong style="color: #333;">Whisk Prompt:</strong>
              <button class="btn-submit" id="copyPromptBtn" style="padding: 6px 12px; font-size: 0.85rem;">ğŸ“‹ Copy Whisk</button>
            </div>
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; line-height: 1.6; color: #333; border-left: 4px solid #667eea;">
              ${escapeHtml(imagePrompt)}
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <strong style="color: #333;">Designer Brief (Easy Reading):</strong>
              <button class="btn-submit" id="copyDesignerBtn" style="padding: 6px 12px; font-size: 0.85rem; background: #52c41a;">ğŸ“‹ Copy Brief</button>
            </div>
            <div id="designerBriefText" style="background: white; padding: 15px; border-radius: 8px; line-height: 1.8; color: #333; border: 2px solid #52c41a;">
              ${designerBrief}
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn-submit" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" id="openWhiskBtn">ğŸ¨ Open Whisk in Popup</button>
            <button class="btn-submit" style="background: #888;" id="editPromptBtn">âœï¸ Edit Prompt</button>
          </div>
        `;
        
        // Attach event listeners instead of inline onclick
        document.getElementById('copyPromptBtn').addEventListener('click', copyCurrentPrompt);
        document.getElementById('copyDesignerBtn').addEventListener('click', () => {
          const briefElement = document.getElementById('designerBriefText');
          const briefText = briefElement.innerText;
          navigator.clipboard.writeText(briefText).then(() => {
            showStatus('âœ… Designer brief copied!', 'success');
          }).catch(() => {
            showStatus('âŒ Copy failed', 'error');
          });
        });
        document.getElementById('openWhiskBtn').addEventListener('click', () => openWhiskPopup(whiskUrl));
        document.getElementById('editPromptBtn').addEventListener('click', showEditPromptModal);
      }
      
      document.getElementById('modal').style.display = 'flex';
    }

    // â”€â”€â”€ FORMAT DESIGNER BRIEF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function formatDesignerBrief(prompt, aspectRatio) {
      const formatLabel = aspectRatio === '4:5' 
        ? '4:5 Vertical (1080x1350px) - Instagram/Facebook Feed' 
        : aspectRatio === '9:16' 
        ? '9:16 Tall Vertical (1080x1920px) - TikTok/Stories' 
        : 'Standard Format';
      
      let brief = `<strong style="font-size: 1.1rem; color: #667eea;">ğŸ“ FORMAT:</strong><br>`;
      brief += `${formatLabel}<br><br>`;
      
      brief += `<strong style="font-size: 1.1rem; color: #667eea;">ğŸ¨ IMAGE REQUIREMENTS:</strong><br>`;
      
      // Parse the prompt and extract key elements
      const sentences = prompt.split(/[.!]\s+/);
      
      sentences.forEach(sentence => {
        if (sentence.trim().length > 10) {
          brief += `â€¢ ${escapeHtml(sentence.trim())}<br>`;
        }
      });
      
      brief += `<br><strong style="font-size: 1.1rem; color: #667eea;">âœ… CHECKLIST:</strong><br>`;
      brief += `â€¢ Leave space for text overlay (hook/headline)<br>`;
      brief += `â€¢ Product prominently featured<br>`;
      brief += `â€¢ Premium, trustworthy aesthetic<br>`;
      brief += `â€¢ Optimized for ${aspectRatio || 'standard'} aspect ratio<br>`;
      
      return brief;
    }

    // â”€â”€â”€ COPY DESIGNER BRIEF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function copyDesignerBrief(prompt) {
      // Convert HTML entities back
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = prompt;
      const plainPrompt = tempDiv.textContent || tempDiv.innerText;
      
      navigator.clipboard.writeText(plainPrompt).then(() => {
        showStatus('âœ… Designer brief copied!', 'success');
      }).catch(() => {
        showStatus('âŒ Copy failed', 'error');
      });
    }

    // â”€â”€â”€ COPY PROMPT BY RATIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function copyPromptByRatio(ratio) {
      if (Array.isArray(S.currentImagePrompt)) {
        const prompt = S.currentImagePrompt.find(p => p.ratio === ratio);
        if (prompt) {
          navigator.clipboard.writeText(prompt.imagePrompt).then(() => {
            showStatus(`âœ… ${ratio} prompt copied!`, 'success');
          }).catch(() => {
            showStatus('âŒ Failed to copy', 'error');
          });
        }
      }
    }

    // â”€â”€â”€ COPY CURRENT PROMPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function copyCurrentPrompt() {
      const text = typeof S.currentImagePrompt === 'string' ? S.currentImagePrompt : S.currentImagePrompt[0]?.imagePrompt || '';
      navigator.clipboard.writeText(text).then(() => {
        showStatus('âœ… Prompt copied!', 'success');
      }).catch(() => {
        showStatus('âŒ Copy failed', 'error');
      });
    }

    // â”€â”€â”€ OPEN WHISK IN POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openWhiskPopup(whiskUrl) {
      // Open Whisk in a popup window (900x800, keeps both visible)
      window.open(whiskUrl, 'WhiskWindow', 'width=900,height=800,left=100,top=100,resizable=yes,scrollbars=yes');
    }

    // â”€â”€â”€ CLOSE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function closeModal(event) {
      if (event && event.target.id !== 'modal') return;
      document.getElementById('modal').style.display = 'none';
    }

    // â”€â”€â”€ TOGGLE SCRAPER RUN DETAILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleScraperRunDetails(event, runId) {
      event.stopPropagation();
      const detailsEl = document.getElementById(`details-${runId}`);
      const iconEl = document.getElementById(`icon-${runId}`);
      
      if (detailsEl) {
        const isHidden = detailsEl.style.display === 'none';
        detailsEl.style.display = isHidden ? 'block' : 'none';
        if (iconEl) {
          iconEl.textContent = isHidden ? 'â–¼' : 'â–¶';
        }
      }
    }

    // â”€â”€â”€ EDIT PROMPT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showEditPromptModal() {
      const modalBody = document.getElementById('modalBody');
      modalBody.innerHTML = `
        <h2>âœï¸ Edit Image Prompt</h2>
        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #667eea; max-height: 200px; overflow-y: auto; line-height: 1.6; color: #333; font-size: 0.9rem;">
          <strong>Current prompt:</strong><br>${escapeHtml(S.currentImagePrompt)}
        </div>
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">What's wrong? What should change?</label>
        <textarea id="editPromptFeedback" placeholder="e.g. 'make it more vibrant' or 'remove the sunset, add a kitchen scene' or 'too clinical looking, make it warmer'" style="width: 100%; height: 100px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; margin-bottom: 15px; resize: vertical;"></textarea>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn-submit" id="regeneratePromptBtn">ğŸ”„ Fix & Regenerate</button>
          <button class="btn-submit" style="background: #666;" onclick="closeModal()">â† Back</button>
        </div>
      `;
      
      document.getElementById('regeneratePromptBtn').addEventListener('click', regenerateImagePrompt);
      document.getElementById('modal').style.display = 'flex';
    }

    // â”€â”€â”€ REGENERATE IMAGE PROMPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function regenerateImagePrompt() {
      const userEdits = document.getElementById('editPromptFeedback').value;
      if (!userEdits.trim()) {
        showStatus('âŒ Tell Ollama what to fix', 'error');
        return;
      }

      const btn = document.getElementById('regeneratePromptBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Regenerating...';

      try {
        showStatus('ğŸ¨ Regenerating with Ollama...', 'loading');

        const res = await fetch('/api/regenerate-image-prompt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            currentPrompt: S.currentImagePrompt,
            userEdits: userEdits,
            hook: S.hooks[0] // Would need to track current hook
          })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error);
        }

        const data = await res.json();
        S.currentImagePrompt = data.imagePrompt;
        
        showStatus('âœ… Prompt regenerated!', 'success');
        showImagePromptModal(data.imagePrompt, data.whiskUrl);
      } catch (err) {
        showStatus('âŒ ' + err.message, 'error');
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”„ Regenerate';
      }
    }

    // â”€â”€â”€ EDIT HOOK MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showEditHookModal(hookIdx) {
      const currentHook = S.hooks[hookIdx];
      const modalBody = document.getElementById('modalBody');
      modalBody.innerHTML = `
        <h2>âœï¸ Edit Hook ${hookIdx + 1}</h2>
        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #667eea;">
          <strong>Current hook:</strong><br>${escapeHtml(currentHook)}
        </div>
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">What's wrong? What should change?</label>
        <textarea id="editHookFeedback" placeholder="e.g. 'the word oral sounds weird, replace with something like take a pill instead' or 'too generic, make it more urgent' or 'good but shorten it'" style="width: 100%; height: 100px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; margin-bottom: 15px; resize: vertical;"></textarea>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn-submit" id="regenerateHookBtn" data-hook-idx="${hookIdx}">ğŸ”„ Fix & Regenerate</button>
          <button class="btn-submit" style="background: #666;" onclick="document.getElementById('modal').style.display='none';">â† Back</button>
        </div>
      `;
      
      document.getElementById('regenerateHookBtn').addEventListener('click', regenerateHook);
      document.getElementById('modal').style.display = 'flex';
    }

    // â”€â”€â”€ REGENERATE HOOK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function regenerateHook() {
      const hookIdx = parseInt(document.getElementById('regenerateHookBtn').dataset.hookIdx);
      const userEdits = document.getElementById('editHookFeedback').value;
      
      if (!userEdits.trim()) {
        showStatus('âŒ Tell Ollama what to fix', 'error');
        return;
      }

      const btn = document.getElementById('regenerateHookBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Regenerating...';

      try {
        showStatus('ğŸ¯ Regenerating with Ollama...', 'loading');

        const res = await fetch('/api/regenerate-hook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            productName: S.productName,
            angle: S.selectedAngle,
            currentHook: S.hooks[hookIdx],
            userEdits: userEdits
          })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error);
        }

        const data = await res.json();
        S.hooks[hookIdx] = data.hook;
        
        showStatus('âœ… Hook regenerated!', 'success');
        document.getElementById('modal').style.display = 'none';
        renderHooks();
      } catch (err) {
        showStatus('âŒ ' + err.message, 'error');
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”„ Regenerate';
      }
    }

    // â”€â”€â”€ EDIT ANGLE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showEditAngleModal(angleIdx) {
      const currentAngle = S.angles[angleIdx];
      const modalBody = document.getElementById('modalBody');
      modalBody.innerHTML = `
        <h2>âœï¸ Edit Angle ${angleIdx + 1}</h2>
        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #667eea;">
          <strong>Current angle:</strong><br>${escapeHtml(currentAngle)}
        </div>
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">What's wrong? What should change?</label>
        <textarea id="editAngleFeedback" placeholder="e.g. 'too generic, make it more specific' or 'good but shorten it' or 'focus more on convenience'" style="width: 100%; height: 100px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; margin-bottom: 15px; resize: vertical;"></textarea>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn-submit" id="regenerateAngleBtn" data-angle-idx="${angleIdx}">ğŸ”„ Fix & Regenerate</button>
          <button class="btn-submit" style="background: #666;" onclick="document.getElementById('modal').style.display='none';">â† Back</button>
        </div>
      `;
      
      document.getElementById('regenerateAngleBtn').addEventListener('click', regenerateAngle);
      document.getElementById('modal').style.display = 'flex';
    }

    // â”€â”€â”€ REGENERATE ANGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function regenerateAngle() {
      const angleIdx = parseInt(document.getElementById('regenerateAngleBtn').dataset.angleIdx);
      const userEdits = document.getElementById('editAngleFeedback').value;
      
      if (!userEdits.trim()) {
        showStatus('âŒ Tell Ollama what to fix', 'error');
        return;
      }

      const btn = document.getElementById('regenerateAngleBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Regenerating...';

      try {
        showStatus('âœ¨ Regenerating with Ollama...', 'loading');

        const res = await fetch('/api/regenerate-angle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            productName: S.productName,
            productContext: S.productContext,
            currentAngle: S.angles[angleIdx],
            userEdits: userEdits
          })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error);
        }

        const data = await res.json();
        S.angles[angleIdx] = data.angle;
        
        showStatus('âœ… Angle regenerated!', 'success');
        document.getElementById('modal').style.display = 'none';
        renderAngles();
      } catch (err) {
        showStatus('âŒ ' + err.message, 'error');
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”„ Regenerate';
      }
    }

    // â”€â”€â”€ START NEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startNew() {
      if (confirm('Start a new project? This will clear everything.')) {
        // Save current session before clearing
        saveToHistory();
        
        // Full page refresh to clear everything from scratch
        location.reload();
      }
    }

    // â”€â”€â”€ COPY ALL HOOKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function copyAllHooks() {
      const text = S.hooks.join('\n\n');
      navigator.clipboard.writeText(text).then(() => {
        showStatus('âœ… All hooks copied!', 'success');
      });
    }

    // â”€â”€â”€ UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    function showStatus(msg, type = 'info') {
      let statusEl = document.getElementById('statusMessage');
      if (!statusEl) {
        statusEl = document.createElement('div');
        statusEl.id = 'statusMessage';
        document.body.insertBefore(statusEl, document.body.firstChild);
      }

      statusEl.textContent = msg;
      statusEl.className = type;
      statusEl.style.display = 'flex';

      if (type === 'success' || type === 'error') {
        setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
      }
    }

    window.addEventListener('load', () => {
      initNewsCards();
      loadCompetitorNews();
    });
  </script>
</body>
</html>
